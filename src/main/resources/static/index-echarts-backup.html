<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸­å›½æ—…æ¸¸åŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .navbar {
            width: 100%;
            height: 60px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            position: relative;
            z-index: 1000;
        }

        .navbar .logo {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            display: flex;
            align-items: center;
        }

        .navbar .logo::before {
            content: 'ğŸ—ºï¸';
            margin-right: 10px;
            font-size: 28px;
        }

        .navbar .user-status {
            font-size: 14px;
            color: #666;
        }

        /* ä¸»ä½“å®¹å™¨ */
        .main-container {
            display: flex;
            height: calc(100vh - 60px);
            width: 100%;
        }

        /* å·¦ä¾§åœ°å›¾å®¹å™¨ */
        .map-section {
            width: 70%;
            height: 100%;
            background: #1a1a2e;
            position: relative;
        }

        #map-container {
            width: 100%;
            height: 100%;
        }

        /* å³ä¾§ä¿¡æ¯é¢æ¿ */
        .info-section {
            width: 30%;
            height: 100%;
            background: #f8f9fa;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        }

        #info-panel {
            padding: 30px;
        }

        .info-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
        }

        .welcome-message {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .welcome-message .icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .welcome-message p {
            font-size: 18px;
            line-height: 1.6;
        }

        /* åŸå¸‚åˆ—è¡¨æ ·å¼ */
        .city-list {
            margin-top: 20px;
        }

        .city-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid #667eea;
        }

        .city-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .city-item h3 {
            font-size: 18px;
            color: #333;
            margin-bottom: 8px;
        }

        .city-item p {
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }

        /* æ™¯ç‚¹åˆ—è¡¨æ ·å¼ */
        .attraction-list {
            margin-top: 20px;
        }

        .attraction-item {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .attraction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        .attraction-item h3 {
            font-size: 16px;
            color: #333;
            margin-bottom: 8px;
        }

        .attraction-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }

        .attraction-rating {
            color: #f39c12;
            font-weight: bold;
        }

        .attraction-views {
            color: #3498db;
        }

        /* è¿”å›æŒ‰é’® */
        .back-button {
            display: inline-block;
            padding: 8px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 15px;
            transition: background 0.3s;
        }

        .back-button:hover {
            background: #5568d3;
        }

        /* åŠ è½½æç¤º */
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        .info-section::-webkit-scrollbar {
            width: 8px;
        }

        .info-section::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .info-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .info-section::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Modal æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: #fefefe;
            margin: 3% auto;
            padding: 0;
            border-radius: 12px;
            width: 80%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 25px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px 12px 0 0;
            position: relative;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }

        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            line-height: 1;
        }

        .modal-close:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
        }

        .modal-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .modal-stats {
            display: flex;
            gap: 30px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .modal-stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
        }

        .modal-stat-item .icon {
            font-size: 20px;
        }

        .modal-description {
            line-height: 1.8;
            color: #555;
            font-size: 15px;
            margin-bottom: 25px;
            text-align: justify;
        }

        .modal-comments {
            margin-top: 30px;
        }

        .modal-comments h3 {
            font-size: 20px;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .comment-item {
            background: #f8f9fa;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
            color: #999;
        }

        .comment-user {
            font-weight: bold;
            color: #667eea;
        }

        .comment-content {
            color: #555;
            line-height: 1.6;
            font-size: 14px;
        }

        .no-comments {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 14px;
        }

        /* åŸå¸‚æŒ‰é’®æ ·å¼ */
        .city-button {
            width: 100%;
            padding: 15px;
            margin-bottom: 12px;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            color: #333;
            text-align: left;
        }

        .city-button:hover {
            background: #667eea;
            color: white;
            transform: translateX(5px);
        }

        .city-button-name {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 5px;
        }

        .city-button-desc {
            font-size: 13px;
            opacity: 0.8;
        }

        /* æ™¯ç‚¹å¡ç‰‡æ ·å¼ */
        .attraction-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            cursor: pointer;
        }

        .attraction-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .attraction-card-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
        }

        .attraction-card-body {
            padding: 15px;
        }

        .attraction-card-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        .attraction-card-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .attraction-card-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .attraction-card-rating {
            color: #f39c12;
            font-weight: bold;
        }

        .attraction-card-views {
            color: #3498db;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <div class="navbar">
        <div class="logo">ä¸­å›½æ—…æ¸¸åŠ©æ‰‹</div>
        <div class="user-status">æ¬¢è¿ä½¿ç”¨ | åœ¨çº¿</div>
    </div>

    <!-- ä¸»ä½“å®¹å™¨ -->
    <div class="main-container">
        <!-- å·¦ä¾§åœ°å›¾ -->
        <div class="map-section">
            <div id="map-container"></div>
        </div>

        <!-- å³ä¾§ä¿¡æ¯é¢æ¿ -->
        <div class="info-section">
            <div id="info-panel">
                <div class="welcome-message">
                    <div class="icon">ğŸ—ºï¸</div>
                    <p>è¯·é€‰æ‹©çœä»½æŸ¥çœ‹è¯¦æƒ…</p>
                    <p style="font-size: 14px; margin-top: 10px; color: #ccc;">
                        æ¢ç´¢ä¸­å›½å„åœ°çš„ç¾ä¸½é£æ™¯
                    </p>
                </div>
                <div style="padding: 0 30px; margin-top: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button class="city-button" style="margin: 0;" onclick="loadProvinceInfo('æ¹–åŒ—çœ')">
                            <div class="city-button-name">ğŸŒ¸ æ¹–åŒ—çœ</div>
                        </button>
                        <button class="city-button" style="margin: 0;" onclick="loadProvinceInfo('åŒ—äº¬å¸‚')">
                            <div class="city-button-name">ğŸ›ï¸ åŒ—äº¬å¸‚</div>
                        </button>
                        <button class="city-button" style="margin: 0;" onclick="loadProvinceInfo('å¹¿ä¸œçœ')">
                            <div class="city-button-name">ğŸŒ´ å¹¿ä¸œçœ</div>
                        </button>
                        <button class="city-button" style="margin: 0;" onclick="loadProvinceInfo('å››å·çœ')">
                            <div class="city-button-name">ğŸŒ¶ï¸ å››å·çœ</div>
                        </button>
                        <button class="city-button" style="margin: 0;" onclick="loadProvinceInfo('æµ™æ±Ÿçœ')">
                            <div class="city-button-name">ğŸï¸ æµ™æ±Ÿçœ</div>
                        </button>
                        <button class="city-button" style="margin: 0;" onclick="loadProvinceInfo('æ±Ÿè‹çœ')">
                            <div class="city-button-name">ğŸŒº æ±Ÿè‹çœ</div>
                        </button>
                        <button class="city-button" style="margin: 0;" onclick="loadProvinceInfo('é™•è¥¿çœ')">
                            <div class="city-button-name">ğŸ¯ é™•è¥¿çœ</div>
                        </button>
                        <button class="city-button" style="margin: 0;" onclick="loadProvinceInfo('äº‘å—çœ')">
                            <div class="city-button-name">ğŸŒ» äº‘å—çœ</div>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ™¯ç‚¹è¯¦æƒ…Modal -->
    <div id="attractionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">æ™¯ç‚¹è¯¦æƒ…</h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody" class="modal-body">
                <!-- åŠ¨æ€å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
            </div>
        </div>
    </div>

    <!-- å¼•å…¥ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@2.0.9/dist/echarts-gl.min.js"></script>

    <script>
        // å…¨å±€å˜é‡
        let myChart;
        let chinaGeoJSON;
        let currentProvince = null;

        // çœä»½åç§°åˆ°IDçš„æ˜ å°„
        const provinceNameToId = {
            'åŒ—äº¬': 2,
            'åŒ—äº¬å¸‚': 2,
            'æ¹–åŒ—': 1,
            'æ¹–åŒ—çœ': 1,
            'å¹¿ä¸œ': 3,
            'å¹¿ä¸œçœ': 3,
            'å››å·': 4,
            'å››å·çœ': 4,
            'æµ™æ±Ÿ': 5,
            'æµ™æ±Ÿçœ': 5,
            'æ±Ÿè‹': 6,
            'æ±Ÿè‹çœ': 6,
            'é™•è¥¿': 7,
            'é™•è¥¿çœ': 7,
            'äº‘å—': 8,
            'äº‘å—çœ': 8
        };

        // åˆå§‹åŒ–åœ°å›¾
        function initMap() {
            console.log('=== å¼€å§‹åˆå§‹åŒ–åœ°å›¾ ===');
            myChart = echarts.init(document.getElementById('map-container'));
            console.log('ECharts å®ä¾‹åˆ›å»ºæˆåŠŸ');

            // åŠ è½½ä¸­å›½åœ°å›¾GeoJSONæ•°æ®
            $.getJSON('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json', function(geoJson) {
                console.log('GeoJSON æ•°æ®åŠ è½½æˆåŠŸ');
                chinaGeoJSON = geoJson;
                echarts.registerMap('china', geoJson);

                // é…ç½®3Dåœ°å›¾
                const option = {
                    backgroundColor: '#1a1a2e',
                    tooltip: {
                        show: true,
                        formatter: function(params) {
                            return params.name + '<br/>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…';
                        }
                    },
                    visualMap: {
                        show: false,
                        min: 0,
                        max: 1,
                        inRange: {
                            color: ['#313695', '#4575b4', '#74add1', '#abd9e9']
                        }
                    },
                    geo3D: {
                        map: 'china',
                        roam: true,
                        // å¯ç”¨é€‰ä¸­åŠŸèƒ½
                        selectedMode: 'single',
                        select: {
                            label: {
                                show: true,
                                color: '#fff',
                                fontSize: 18,
                                fontWeight: 'bold'
                            },
                            itemStyle: {
                                color: '#e74c3c',
                                opacity: 1
                            }
                        },
                        itemStyle: {
                            color: '#2c3e50',
                            opacity: 0.9,
                            borderWidth: 1,
                            borderColor: '#1abc9c'
                        },
                        emphasis: {
                            label: {
                                show: true,
                                color: '#fff',
                                fontSize: 16,
                                fontWeight: 'bold'
                            },
                            itemStyle: {
                                color: '#f39c12',
                                opacity: 1
                            }
                        },
                        light: {
                            main: {
                                intensity: 1.2,
                                shadow: true,
                                shadowQuality: 'high',
                                alpha: 40
                            },
                            ambient: {
                                intensity: 0.3
                            }
                        },
                        viewControl: {
                            distance: 80,
                            alpha: 45,
                            beta: 0,
                            autoRotate: false,
                            rotateSensitivity: 1,
                            zoomSensitivity: 1,
                            panSensitivity: 1,
                            minAlpha: 5,
                            maxAlpha: 90
                        },
                        shading: 'realistic',
                        realisticMaterial: {
                            roughness: 0.6,
                            metalness: 0
                        },
                        postEffect: {
                            enable: true,
                            bloom: {
                                enable: true,
                                intensity: 0.1
                            },
                            SSAO: {
                                enable: true,
                                radius: 2
                            }
                        },
                        regionHeight: 3
                    }
                };

                myChart.setOption(option);

                console.log('ECharts åœ°å›¾é…ç½®å®Œæˆï¼Œå¼€å§‹ç›‘å¬ç‚¹å‡»äº‹ä»¶');

                // ========== æ–¹æ¡ˆï¼šä½¿ç”¨ geo3D çš„ selectchanged äº‹ä»¶ ==========
                let lastClickTime = 0;
                let lastClickedName = null;
                
                // ç›‘å¬ geo3D çš„é€‰ä¸­äº‹ä»¶
                myChart.on('selectchanged', function(params) {
                    console.log('>>> selectchanged äº‹ä»¶è§¦å‘ <<<', params);
                    
                    if (params && params.selected && params.selected.length > 0) {
                        const selectedRegion = params.selected[0];
                        if (selectedRegion.name) {
                            console.log('âœ… é€‰ä¸­çš„çœä»½:', selectedRegion.name);
                            loadProvinceInfo(selectedRegion.name);
                        }
                    }
                });
                
                // å¤‡ç”¨æ–¹æ¡ˆï¼šç›‘å¬åŒå‡»äº‹ä»¶
                myChart.on('dblclick', function(params) {
                    console.log('>>> åŒå‡»äº‹ä»¶è§¦å‘ <<<', params);
                    if (params && params.name) {
                        console.log('âœ… åŒå‡»çš„çœä»½:', params.name);
                        loadProvinceInfo(params.name);
                    }
                });
                
                // å¤‡ç”¨æ–¹æ ˆ2ï¼šç›‘å¬é¼ æ ‡ç§»åŠ¨ + ç‚¹å‡»ç»„åˆ
                let hoveredProvince = null;
                
                myChart.on('mouseover', function(params) {
                    if (params && params.name) {
                        hoveredProvince = params.name;
                        console.log('é¼ æ ‡æ‚¬åœ:', params.name);
                    }
                });
                
                myChart.on('mouseout', function(params) {
                    // ä¸æ¸…ç©º hoveredProvinceï¼Œä¿ç•™æœ€åä¸€æ¬¡æ‚¬åœçš„çœä»½
                });
                
                // ç›‘å¬ç‚¹å‡»äº‹ä»¶ï¼ˆå°è¯•æ‰€æœ‰å¯èƒ½çš„äº‹ä»¶ï¼‰
                myChart.on('click', function(params) {
                    console.log('>>> click äº‹ä»¶è§¦å‘ <<<', params);
                    
                    const now = Date.now();
                    const provinceName = params.name || hoveredProvince;
                    
                    if (provinceName) {
                        // åŒå‡»æ£€æµ‹ï¼šå¦‚æœ300mså†…ç‚¹å‡»åŒä¸€ä¸ªçœä»½ä¸¤æ¬¡
                        if (lastClickedName === provinceName && (now - lastClickTime) < 300) {
                            console.log('âœ… æ£€æµ‹åˆ°åŒå‡»:', provinceName);
                            loadProvinceInfo(provinceName);
                            lastClickTime = 0;
                            lastClickedName = null;
                        } else {
                            // å•å‡»ï¼šè®°å½•å¹¶ç­‰å¾…ä¸‹ä¸€æ¬¡ç‚¹å‡»
                            console.log('å•å‡»è®°å½•:', provinceName, 'ï¼ˆå†æ¬¡ç‚¹å‡»ä»¥åŠ è½½ä¿¡æ¯ï¼‰');
                            lastClickTime = now;
                            lastClickedName = provinceName;
                            
                            // æ˜¾ç¤ºæç¤º
                            $('#info-panel').html(`
                                <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ‘†</div>
                                    <div style="font-size: 16px; color: #2e7d32; font-weight: bold;">
                                        æ‚¨é€‰ä¸­äº†ï¼š${provinceName}
                                    </div>
                                    <div style="font-size: 14px; color: #66bb6a; margin-top: 10px;">
                                        è¯·<strong>å†æ¬¡ç‚¹å‡»</strong>è¯¥çœä»½ä»¥æŸ¥çœ‹è¯¦æƒ…
                                    </div>
                                </div>
                            `);
                        }
                    } else {
                        console.log('âš ï¸ æœªæ£€æµ‹åˆ°çœä»½åç§°');
                    }
                });
                // ========================================================

                // çª—å£å¤§å°æ”¹å˜æ—¶é‡æ–°æ¸²æŸ“
                window.addEventListener('resize', function() {
                    myChart.resize();
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                console.error('GeoJSON åŠ è½½å¤±è´¥:', textStatus, errorThrown);
                alert('GeoJSON åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
            });
        }

        // åŠ è½½çœä»½ä¿¡æ¯
        function loadProvinceInfo(provinceName) {
            console.log('ç‚¹å‡»çš„çœä»½åç§°:', provinceName);
            
            // ç›´æ¥æŸ¥æ‰¾çœä»½ ID
            let provinceId = provinceNameToId[provinceName];
            
            // å¦‚æœç›´æ¥æŸ¥æ‰¾ä¸åˆ°ï¼Œå°è¯•æ¨¡ç³ŠåŒ¹é…
            if (!provinceId) {
                for (let key in provinceNameToId) {
                    if (provinceName.includes(key) || key.includes(provinceName)) {
                        provinceId = provinceNameToId[key];
                        currentProvince = key.replace('çœ', '').replace('å¸‚', '');
                        break;
                    }
                }
            } else {
                currentProvince = provinceName.replace('çœ', '').replace('å¸‚', '');
            }
            
            console.log('è§£æåçš„çœä»½ID:', provinceId, 'çœä»½å:', currentProvince);

            if (!provinceId) {
                $('#info-panel').html(`
                    <div class="info-title">${provinceName}</div>
                    <p style="color: #999; text-align: center; padding: 50px 20px;">
                        æš‚æ— è¯¥çœä»½çš„è¯¦ç»†ä¿¡æ¯<br/>
                        <small>è¯·å°è¯•ç‚¹å‡»å…¶ä»–çœä»½ï¼šæ¹–åŒ—ã€åŒ—äº¬ã€å¹¿ä¸œã€å››å·ã€æµ™æ±Ÿã€æ±Ÿè‹ã€é™•è¥¿ã€äº‘å—</small>
                    </p>
                `);
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            $('#info-panel').html('<div class="loading">åŠ è½½ä¸­...</div>');

            // è°ƒç”¨APIè·å–åŸå¸‚åˆ—è¡¨
            $.ajax({
                url: `/api/cities/${provinceId}`,
                method: 'GET',
                success: function(response) {
                    console.log('APIè¿”å›æ•°æ®:', response);
                    if (response.code === 200 && response.data) {
                        displayCities(currentProvince, response.data);
                    } else {
                        $('#info-panel').html('<p style="color: red;">åŠ è½½å¤±è´¥ï¼š' + (response.msg || 'æœªçŸ¥é”™è¯¯') + '</p>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('APIè°ƒç”¨å¤±è´¥:', status, error, xhr);
                    $('#info-panel').html(`
                        <p style="color: red; padding: 20px;">
                            ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•<br/>
                            <small>é”™è¯¯ä¿¡æ¯: ${error}</small>
                        </p>
                    `);
                }
            });
        }

        // æ˜¾ç¤ºåŸå¸‚åˆ—è¡¨ï¼ˆä½¿ç”¨æŒ‰é’®æ ·å¼ï¼‰
        function displayCities(provinceName, cities) {
            let html = `
                <div class="info-title">${provinceName}çœ - åŸå¸‚åˆ—è¡¨</div>
                <div class="city-list">
            `;

            cities.forEach(city => {
                const desc = city.description || 'æš‚æ— æè¿°';
                const shortDesc = desc.length > 50 ? desc.substring(0, 50) + '...' : desc;
                
                html += `
                    <button class="city-button" data-city-id="${city.id}" data-city-name="${city.name}">
                        <div class="city-button-name">${city.name}</div>
                        <div class="city-button-desc">${shortDesc}</div>
                    </button>
                `;
            });

            html += '</div>';
            $('#info-panel').html(html);

            // ç»‘å®šåŸå¸‚æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('.city-button').click(function() {
                const cityId = $(this).data('city-id');
                const cityName = $(this).data('city-name');
                loadCityAttractions(cityId, cityName);
            });
        }

        // åŠ è½½åŸå¸‚æ™¯ç‚¹
        function loadCityAttractions(cityId, cityName) {
            $('#info-panel').html('<div class="loading">åŠ è½½æ™¯ç‚¹ä¸­...</div>');

            $.ajax({
                url: `/api/attractions/top/${cityId}?limit=10`,
                method: 'GET',
                success: function(response) {
                    if (response.code === 200 && response.data) {
                        displayAttractions(cityName, response.data);
                    } else {
                        $('#info-panel').html('<p style="color: red;">åŠ è½½æ™¯ç‚¹å¤±è´¥</p>');
                    }
                },
                error: function() {
                    $('#info-panel').html('<p style="color: red;">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>');
                }
            });
        }

        // æ˜¾ç¤ºæ™¯ç‚¹åˆ—è¡¨ï¼ˆä½¿ç”¨å¡ç‰‡æ ·å¼ï¼‰
        function displayAttractions(cityName, attractions) {
            let html = `
                <button class="back-button" onclick="loadProvinceInfo('${currentProvince}')">â† è¿”å›åŸå¸‚åˆ—è¡¨</button>
                <div class="info-title">${cityName} - çƒ­é—¨æ™¯ç‚¹</div>
                <div class="attraction-list">
            `;

            if (attractions && attractions.length > 0) {
                attractions.forEach((attraction, index) => {
                    const desc = attraction.description || 'æš‚æ— æè¿°';
                    const shortDesc = desc.length > 60 ? desc.substring(0, 60) + '...' : desc;
                    
                    html += `
                        <div class="attraction-card" data-attraction-id="${attraction.id}">
                            <div class="attraction-card-image">ğŸ›ï¸</div>
                            <div class="attraction-card-body">
                                <div class="attraction-card-title">${index + 1}. ${attraction.name}</div>
                                <div class="attraction-card-desc">${shortDesc}</div>
                                <div class="attraction-card-stats">
                                    <span class="attraction-card-rating">â­ ${attraction.rating || 'N/A'}</span>
                                    <span class="attraction-card-views">ğŸ‘ï¸ ${attraction.viewCount || 0}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="text-align: center; color: #999; padding: 30px;">æš‚æ— æ™¯ç‚¹æ•°æ®</p>';
            }

            html += '</div>';
            $('#info-panel').html(html);

            // ç»‘å®šæ™¯ç‚¹å¡ç‰‡ç‚¹å‡»äº‹ä»¶ - æ‰“å¼€Modal
            $('.attraction-card').click(function() {
                const attractionId = $(this).data('attraction-id');
                openAttractionModal(attractionId);
            });
        }

        // æ‰“å¼€æ™¯ç‚¹è¯¦æƒ…Modal
        function openAttractionModal(attractionId) {
            // æ˜¾ç¤ºModalå¹¶åŠ è½½æ•°æ®
            $('#attractionModal').fadeIn(300);
            $('#modalBody').html('<div class="loading" style="padding: 50px; text-align: center;">åŠ è½½è¯¦æƒ…ä¸­...</div>');

            $.ajax({
                url: `/api/attractions/${attractionId}/detail`,
                method: 'GET',
                success: function(response) {
                    if (response.code === 200 && response.data) {
                        displayAttractionInModal(response.data);
                    } else {
                        $('#modalBody').html('<p style="color: red; text-align: center; padding: 50px;">åŠ è½½è¯¦æƒ…å¤±è´¥</p>');
                    }
                },
                error: function() {
                    $('#modalBody').html('<p style="color: red; text-align: center; padding: 50px;">ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•</p>');
                }
            });
        }

        // åœ¨Modalä¸­æ˜¾ç¤ºæ™¯ç‚¹è¯¦æƒ…
        function displayAttractionInModal(data) {
            const attraction = data.attraction;
            const comments = data.comments || [];

            // è®¾ç½®Modalæ ‡é¢˜
            $('#modalTitle').text(attraction.name);

            // æ„å»ºModalå†…å®¹
            let html = '';

            // æ™¯ç‚¹å›¾ç‰‡ï¼ˆå¦‚æœæœ‰ï¼‰
            if (attraction.imageUrl && attraction.imageUrl.startsWith('http')) {
                html += `<img src="${attraction.imageUrl}" alt="${attraction.name}" class="modal-image">`;
            }

            // æ™¯ç‚¹ç»Ÿè®¡ä¿¡æ¯
            html += `
                <div class="modal-stats">
                    <div class="modal-stat-item">
                        <span class="icon">â­</span>
                        <span>è¯„åˆ†: <strong>${attraction.rating || 'N/A'}</strong></span>
                    </div>
                    <div class="modal-stat-item">
                        <span class="icon">ğŸ‘ï¸</span>
                        <span>æµè§ˆ: <strong>${attraction.viewCount || 0}</strong> æ¬¡</span>
                    </div>
                    <div class="modal-stat-item">
                        <span class="icon">ğŸ’¬</span>
                        <span>è¯„è®º: <strong>${comments.length}</strong> æ¡</span>
                    </div>
                </div>
            `;

            // æ™¯ç‚¹æè¿°
            html += `
                <div class="modal-description">
                    ${attraction.description || 'æš‚æ— è¯¦ç»†æè¿°'}
                </div>
            `;

            // è¯„è®ºåˆ—è¡¨
            html += '<div class="modal-comments">';
            html += `<h3>æ¸¸å®¢è¯„è®º (${comments.length})</h3>`;

            if (comments.length > 0) {
                comments.forEach(comment => {
                    const createTime = comment.createTime ? new Date(comment.createTime).toLocaleString('zh-CN') : 'æœªçŸ¥æ—¶é—´';
                    html += `
                        <div class="comment-item">
                            <div class="comment-header">
                                <span class="comment-user">ç”¨æˆ· #${comment.userId}</span>
                                <span class="comment-time">${createTime}</span>
                            </div>
                            <div class="comment-content">${comment.content}</div>
                        </div>
                    `;
                });
            } else {
                html += '<div class="no-comments">æš‚æ— è¯„è®ºï¼Œå¿«æ¥æŠ¢æ²™å‘å§~</div>';
            }

            html += '</div>';

            $('#modalBody').html(html);
        }

        // æ˜¾ç¤ºçœä»½é€‰æ‹©å™¨ï¼ˆå½“è‡ªåŠ¨æ£€æµ‹å¤±è´¥æ—¶ï¼‰
        function showProvinceSelector() {
            const provinces = ['æ¹–åŒ—çœ', 'åŒ—äº¬å¸‚', 'å¹¿ä¸œçœ', 'å››å·çœ', 'æµ™æ±Ÿçœ', 'æ±Ÿè‹çœ', 'é™•è¥¿çœ', 'äº‘å—çœ'];
            
            let html = `
                <div class="info-title">è¯·é€‰æ‹©çœä»½</div>
                <p style="color: #666; margin-bottom: 20px;">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é€‰æ‹©æ‚¨æƒ³æŸ¥çœ‹çš„çœä»½ï¼š</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            `;
            
            provinces.forEach(province => {
                html += `
                    <button class="city-button" style="margin: 0;" onclick="loadProvinceInfo('${province}')">
                        <div class="city-button-name">${province}</div>
                    </button>
                `;
            });
            
            html += '</div>';
            $('#info-panel').html(html);
        }
        function closeModal() {
            $('#attractionModal').fadeOut(300);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(document).ready(function() {
            console.log('=== é¡µé¢åŠ è½½å®Œæˆ ===');
            console.log('jQuery ç‰ˆæœ¬:', $.fn.jquery);
            console.log('ECharts æ˜¯å¦åŠ è½½:', typeof echarts !== 'undefined');
            console.log('ECharts ç‰ˆæœ¬:', echarts.version);
            
            if (typeof echarts === 'undefined') {
                alert('ECharts åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                return;
            }
            
            initMap();

            // ç‚¹å‡»Modalå¤–éƒ¨åŒºåŸŸå…³é—­Modal
            $('#attractionModal').click(function(event) {
                if (event.target.id === 'attractionModal') {
                    closeModal();
                }
            });

            // ESCé”®å…³é—­Modal
            $(document).keydown(function(event) {
                if (event.key === 'Escape') {
                    closeModal();
                }
            });
        });
    </script>
</body>
</html>
