<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ—ºï¸ ä¸­å›½æ—…æ¸¸åŠ©æ‰‹ - Three.js ç‰ˆ</title>
    
    <!-- å¼•å…¥ä¾èµ–åº“ -->
    <script src="https://unpkg.com/three@0.147.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.147.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background: #f5f7fa;
            color: #ecf0f1;
            margin: 0;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .navbar-brand {
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
        }

        .user-info {
            font-size: 14px;
        }

        .home-btn,
        .logout-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .home-btn:hover,
        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        #container {
            display: flex;
            width: 100vw;
            height: calc(100vh - 60px);
        }

        /* å·¦ä¾§åœ°å›¾å®¹å™¨ */
        #map-container {
            width: 70%;
            height: 100%;
            position: relative;
            background: #6b6b8a;
        }

        #threejs-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        /* åŠ è½½æç¤º */
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å³ä¾§ä¿¡æ¯é¢æ¿ */
        #info-panel {
            width: 30%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            overflow-y: auto;
            border-left: 2px solid #ffffff;
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
        }

        #info-panel::-webkit-scrollbar {
            width: 8px;
        }

        #info-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        #info-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .info-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #ffffff;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
        }

        .welcome-section {
            text-align: center;
            padding: 60px 20px;
        }

        .welcome-icon {
            font-size: 80px;
            margin-bottom: 20px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .welcome-text {
            font-size: 18px;
            color: #ffffff;
            line-height: 1.8;
            opacity: 0.95;
        }

        /* åŸå¸‚æŒ‰é’® */
        .city-button {
            display: block;
            width: 100%;
            padding: 15px 20px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
        }

        .city-button:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }

        .city-button-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .city-button-desc {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.8);
        }

        /* æ™¯ç‚¹å¡ç‰‡ */
        .attraction-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .attraction-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .attraction-card-title {
            font-size: 16px;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .attraction-card-desc {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.85);
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .attraction-card-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .attraction-card-rating {
            color: #f39c12;
        }

        /* è¿”å›æŒ‰é’® */
        .back-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: white;
            color: #667eea;
            transform: translateX(-3px);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 50px;
            color: #3498db;
            font-size: 16px;
        }

        /* æ“ä½œæç¤º */
        .control-hint {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px 20px;
            border-radius: 10px;
            color: #ecf0f1;
            font-size: 13px;
            line-height: 1.8;
            z-index: 5;
            border: 1px solid #1abc9c;
        }

        .control-hint strong {
            color: #1abc9c;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-brand">
            ğŸ—ºï¸ ä¸­å›½æ—…æ¸¸åŠ©æ‰‹
        </div>
        <div class="navbar-user">
            <div class="user-info">
                å½“å‰ç”¨æˆ·ï¼š<span id="username"></span>
            </div>
            <button class="home-btn" onclick="goHome()">è¿”å›é¦–é¡µ</button>
            <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </nav>

    <div id="container">
        <!-- å·¦ä¾§ï¼šThree.js 3D åœ°å›¾ -->
        <div id="map-container">
            <div id="loading">
                <div class="spinner"></div>
                <div style="color: #3498db; font-size: 16px;">åŠ è½½ä¸­å›½åœ°å›¾æ•°æ®...</div>
            </div>
            <canvas id="threejs-canvas"></canvas>
            
            <!-- æ“ä½œæç¤º -->
            <div class="control-hint">
                <strong>ğŸ–±ï¸ æ“ä½œæç¤ºï¼š</strong><br>
                â€¢ å·¦é”®æ‹–æ‹½ï¼šæ—‹è½¬åœ°å›¾<br>
                â€¢ æ»šè½®ï¼šç¼©æ”¾<br>
                â€¢ å³é”®æ‹–æ‹½ï¼šå¹³ç§»<br>
                â€¢ ç‚¹å‡»çœä»½ï¼šæŸ¥çœ‹è¯¦æƒ…
            </div>
        </div>

        <!-- å³ä¾§ï¼šä¿¡æ¯é¢æ¿ -->
        <div id="info-panel">
            <div class="welcome-section">
                <div class="welcome-icon">ğŸ—ºï¸</div>
                <div class="info-title">ä¸­å›½æ—…æ¸¸åŠ©æ‰‹</div>
                <div class="welcome-text">
                    æ¬¢è¿ä½¿ç”¨ä¸­å›½æ—…æ¸¸åŠ©æ‰‹ï¼<br><br>
                    ç‚¹å‡»å·¦ä¾§ 3D åœ°å›¾ä¸Šçš„çœä»½ï¼Œ<br>
                    æ¢ç´¢å„åœ°çš„åŸå¸‚ä¸çƒ­é—¨æ™¯ç‚¹ã€‚<br><br>
                    è®©æˆ‘ä»¬å¼€å§‹æ‚¨çš„æ—…è¡Œä¹‹æ—…å§ï¼
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== å…¨å±€å˜é‡ ====================
        let scene, camera, renderer, controls;
        let raycaster, mouse;
        let provinceGroup; // å­˜å‚¨æ‰€æœ‰çœä»½ Mesh çš„ Group
        let provinceMeshMap = {}; // çœä»½åç§° -> Mesh çš„æ˜ å°„
        let provinceNameToId = {}; // çœä»½åç§° -> ID çš„æ˜ å°„
        let selectedMesh = null; // å½“å‰é€‰ä¸­çš„çœä»½ Mesh
        let hoveredMesh = null; // å½“å‰æ‚¬åœçš„çœä»½ Mesh
        let currentProvince = null; // å½“å‰é€‰ä¸­çš„çœä»½åç§°
        let provinceLabels = []; // å­˜å‚¨æ‰€æœ‰çœä»½æ ‡ç­¾

        // ç»Ÿä¸€çš„æ·±è“è‰²é…è‰²æ–¹æ¡ˆ
        const colorPalette = [
            0x2d4a5c  // æ·±è“è‰²ï¼ˆæ‰€æœ‰çœä»½ç»Ÿä¸€é¢œè‰²ï¼‰
        ];

        // åœ°å›¾æŠ•å½±ï¼ˆD3.jsï¼‰
        const projection = d3.geoMercator()
            .center([104, 35])  // ä¸­å›½åœ°å›¾ä¸­å¿ƒ
            .scale(80)
            .translate([0, 0]);

        // ==================== åˆå§‹åŒ– Three.js åœºæ™¯ ====================
        function initThreeJS() {
            const canvas = document.getElementById('threejs-canvas');
            const container = document.getElementById('map-container');

            // åˆ›å»ºåœºæ™¯
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x6b6b8a); // ç´«ç°è‰²èƒŒæ™¯
            // ç§»é™¤é›¾æ•ˆï¼Œä½¿åœ°å›¾æ›´æ¸…æ™°

            // åˆ›å»ºç›¸æœºï¼ˆè°ƒæ•´ä¸ºç±»ä¼¼å›¾äºŒçš„ä¾§è§†é€è§†è§’åº¦ï¼‰
            camera = new THREE.PerspectiveCamera(
                50,
                container.clientWidth / container.clientHeight,
                0.1,
                1000
            );
            // è®¾ç½®ç›¸æœºä½ç½®ï¼šä»ä¸œå—æ–¹å‘çœ‹å‘åœ°å›¾ä¸­å¿ƒï¼Œå½¢æˆé€è§†æ•ˆæœ
            camera.position.set(120, 50, 80); // Xè½´åç§»æ›´å¤§ï¼Œå½¢æˆä¾§è§†è§’
            camera.lookAt(0, 0, 0);

            // åˆ›å»ºæ¸²æŸ“å™¨
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas, 
                antialias: true,
                alpha: true 
            });
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;

            // æ·»åŠ è½¨é“æ§åˆ¶å™¨
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 80;
            controls.maxDistance = 250;
            controls.maxPolarAngle = Math.PI / 1.5; // å…è®¸æ›´å¹³çš„è§†è§’
            controls.minPolarAngle = Math.PI / 6;  // é™åˆ¶æœ€å°ä»°è§’

            // æ·»åŠ ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            // æ·»åŠ æ–¹å‘å…‰
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 100, 50);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // æ·»åŠ ç‚¹å…‰æºï¼ˆå¢å¼ºè§†è§‰æ•ˆæœï¼‰
            const pointLight = new THREE.PointLight(0x1abc9c, 0.5);
            pointLight.position.set(0, 50, 0);
            scene.add(pointLight);

            // åˆå§‹åŒ– Raycasterï¼ˆç”¨äºç‚¹å‡»æ£€æµ‹ï¼‰
            raycaster = new THREE.Raycaster();
            mouse = new THREE.Vector2();

            // åˆ›å»ºçœä»½ Group
            provinceGroup = new THREE.Group();
            scene.add(provinceGroup);

            console.log('âœ… Three.js åœºæ™¯åˆå§‹åŒ–å®Œæˆ');
        }

        // ==================== åŠ è½½ GeoJSON å¹¶ç”Ÿæˆ 3D åœ°å›¾ ====================
        function loadChinaMap() {
            $.getJSON('https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json', function(geoJson) {
                console.log('âœ… GeoJSON æ•°æ®åŠ è½½æˆåŠŸ');
                
                // éå†æ¯ä¸ªçœä»½çš„ Feature
                geoJson.features.forEach(feature => {
                    const provinceName = feature.properties.name;
                    const geometry = feature.geometry;

                    // åˆ›å»ºçœä»½çš„ 3D Mesh
                    const mesh = createProvinceMesh(geometry, provinceName);
                    if (mesh) {
                        provinceGroup.add(mesh);
                        provinceMeshMap[provinceName] = mesh;
                    }
                });

                // éšè—åŠ è½½æç¤º
                document.getElementById('loading').style.display = 'none';
                console.log(`âœ… å…±ç”Ÿæˆ ${Object.keys(provinceMeshMap).length} ä¸ªçœä»½ Mesh`);

                // åŠ è½½çœä»½IDæ˜ å°„
                loadProvinceMapping();
            }).fail(function() {
                console.error('âŒ GeoJSON åŠ è½½å¤±è´¥');
                alert('åœ°å›¾æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            });
        }

        // ==================== åˆ›å»ºçœä»½çš„ 3D Mesh ====================
        function createProvinceMesh(geometry, provinceName) {
            if (geometry.type === 'Polygon') {
                const mesh = createSinglePolygon(geometry.coordinates, provinceName);
                // ä¸ºå•ä¸ª Polygon æ·»åŠ æ ‡ç­¾
                if (mesh) {
                    addProvinceLabel(mesh, provinceName);
                }
                return mesh;
            } else if (geometry.type === 'MultiPolygon') {
                const group = new THREE.Group();
                group.name = provinceName;
                geometry.coordinates.forEach(polygon => {
                    const mesh = createSinglePolygon(polygon, provinceName, true); // ä¼ å…¥ skipLabel å‚æ•°
                    if (mesh) group.add(mesh);
                });
                
                // åªåœ¨ Group çº§åˆ«æ·»åŠ ä¸€æ¬¡æ ‡ç­¾
                if (group.children.length > 0) {
                    addProvinceLabel(group, provinceName);
                }
                
                return group;
            }
            return null;
        }

        // ==================== åˆ›å»ºå•ä¸ªå¤šè¾¹å½¢ Mesh ====================
        function createSinglePolygon(coordinates, provinceName) {
            const outerRing = coordinates[0]; // å¤–ç¯
            const shape = new THREE.Shape();

            // å°† GeoJSON åæ ‡è½¬æ¢ä¸º Three.js åæ ‡
            outerRing.forEach((coord, index) => {
                const [x, y] = projection(coord);
                if (index === 0) {
                    shape.moveTo(x, -y); // æ³¨æ„ y åæ ‡å–å
                } else {
                    shape.lineTo(x, -y);
                }
            });

            // å¤„ç†å†…ç¯ï¼ˆé•‚ç©ºï¼‰
            if (coordinates.length > 1) {
                coordinates.slice(1).forEach(hole => {
                    const holePath = new THREE.Path();
                    hole.forEach((coord, index) => {
                        const [x, y] = projection(coord);
                        if (index === 0) {
                            holePath.moveTo(x, -y);
                        } else {
                            holePath.lineTo(x, -y);
                        }
                    });
                    shape.holes.push(holePath);
                });
            }

            // æŒ¤å‹è®¾ç½®
            const extrudeSettings = {
                depth: 2,           // æŒ¤å‹åšåº¦
                bevelEnabled: true,
                bevelThickness: 0.2,
                bevelSize: 0.1,
                bevelSegments: 3
            };

            const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);

            // æ ¹æ®çœä»½åç§°åˆ†é…é¢œè‰²ï¼ˆä½¿ç”¨å“ˆå¸Œï¼‰
            const provinceColor = getProvinceColor(provinceName);
            
            // æè´¨ï¼ˆä½¿ç”¨ MeshPhongMaterial å¢å¼ºç«‹ä½“æ„Ÿï¼‰
            const material = new THREE.MeshPhongMaterial({ 
                color: provinceColor,
                transparent: true,
                opacity: 0.95,
                shininess: 20,
                specular: 0x1abc9c,
                emissive: 0x000000,
                emissiveIntensity: 0.1
            });

            const mesh = new THREE.Mesh(geometry, material);
            mesh.name = provinceName;
            mesh.userData = { 
                provinceName: provinceName,
                originalColor: provinceColor
            };
            
            // æ·»åŠ è¾¹æ¡†çº¿ï¼ˆé’è‰²è¾¹ç•Œï¼‰
            const edges = new THREE.EdgesGeometry(geometry);
            const lineMaterial = new THREE.LineBasicMaterial({ 
                color: 0x1abc9c,  // é’è‰²è¾¹æ¡†
                linewidth: 2,
                transparent: true,
                opacity: 0.9
            });
            const lineSegments = new THREE.LineSegments(edges, lineMaterial);
            lineSegments.renderOrder = 1; // ç¡®ä¿è¾¹æ¡†åœ¨ä¸Šå±‚æ¸²æŸ“
            mesh.add(lineSegments); // å°†è¾¹æ¡†æ·»åŠ åˆ°meshä¸­
            
            // ä¸åœ¨è¿™é‡Œæ·»åŠ æ ‡ç­¾ï¼Œç”±ä¸Šå±‚å‡½æ•°æ§åˆ¶

            return mesh;
        }

        // ==================== è·å–çœä»½é¢œè‰²ï¼ˆç»Ÿä¸€æ·±è“è‰²ï¼‰ ====================
        function getProvinceColor(provinceName) {
            return 0x2d4a5c; // æ‰€æœ‰çœä»½ç»Ÿä¸€æ·±è“è‰²
        }

        // ==================== åˆ›å»ºçœä»½åç§°æ ‡ç­¾ ====================
        function createLabel(text, position) {
            // åˆ›å»º Canvasï¼ˆè¿›ä¸€æ­¥å‡å°å°ºå¯¸ï¼‰
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.width = 200;  // å‡å°å®½åº¦
            canvas.height = 50;  // å‡å°é«˜åº¦
            
            // ä¸ç»˜åˆ¶èƒŒæ™¯ï¼Œå®Œå…¨é€æ˜
            context.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶æ–‡æœ¬é˜´å½±ï¼ˆå¢å¼ºå¯è¯»æ€§ï¼‰
            context.font = '28px Arial';  // å‡å°å­—ä½“ï¼Œç§»é™¤ Boldï¼Œæ›´ç»†
            context.strokeStyle = 'rgba(0, 0, 0, 0.9)'; // é»‘è‰²æè¾¹
            context.lineWidth = 3;  // å‡å°æè¾¹å®½åº¦
            context.textAlign = 'center';
            context.textBaseline = 'middle';
            const labelText = text.replace('çœ', '').replace('å¸‚', '');
            context.strokeText(labelText, canvas.width / 2, canvas.height / 2);
            
            // ç»˜åˆ¶ç™½è‰²æ–‡æœ¬
            context.fillStyle = '#ffffff';
            context.fillText(labelText, canvas.width / 2, canvas.height / 2);
            
            // åˆ›å»ºçº¹ç†
            const texture = new THREE.CanvasTexture(canvas);
            texture.needsUpdate = true;
            
            // åˆ›å»º Sprite æè´¨
            const spriteMaterial = new THREE.SpriteMaterial({ 
                map: texture,
                transparent: true,
                opacity: 0.95,
                depthTest: false,
                depthWrite: false
            });
            
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.position.copy(position);
            sprite.scale.set(6, 3, 1); // è¿›ä¸€æ­¥å‡å°æ ‡ç­¾å°ºå¯¸
            sprite.renderOrder = 999;
            
            return sprite;
        }

        // ==================== ä¸º Mesh æ·»åŠ æ ‡ç­¾ ====================
        function addProvinceLabel(mesh, provinceName) {
            // è®¡ç®— Mesh çš„è¾¹ç•Œæ¡†ä¸­å¿ƒ
            const box = new THREE.Box3().setFromObject(mesh);
            const center = new THREE.Vector3();
            box.getCenter(center);
            
            // å°†æ ‡ç­¾æ”¾åœ¨ä¸­å¿ƒç‚¹æ­£ä¸Šæ–¹ï¼ˆå‡å°‘Zè½´åç§»ï¼Œé¿å…é®æŒ¡ï¼‰
            const labelPosition = new THREE.Vector3(center.x, center.y, center.z + 1.5);
            const label = createLabel(provinceName, labelPosition);
            
            // å°†æ ‡ç­¾æ·»åŠ åˆ°åœºæ™¯
            scene.add(label);
            provinceLabels.push(label);
        }

        // ==================== åŠ è½½çœä»½åç§°åˆ°IDçš„æ˜ å°„ ====================
        function loadProvinceMapping() {
            $.ajax({
                url: '/api/provinces',
                method: 'GET',
                success: function(response) {
                    if (response.code === 200 && response.data) {
                        response.data.forEach(province => {
                            provinceNameToId[province.name] = province.id;
                            provinceNameToId[province.name + 'çœ'] = province.id;
                            provinceNameToId[province.name + 'å¸‚'] = province.id;
                        });
                        console.log('âœ… çœä»½IDæ˜ å°„åŠ è½½å®Œæˆ', provinceNameToId);
                    }
                },
                error: function() {
                    console.error('âŒ çœä»½IDæ˜ å°„åŠ è½½å¤±è´¥');
                }
            });
        }

        // ==================== é¼ æ ‡ç§»åŠ¨äº‹ä»¶ï¼ˆæ‚¬åœé«˜äº®ï¼‰ ====================
        function onMouseMove(event) {
            const container = document.getElementById('map-container');
            const rect = container.getBoundingClientRect();

            // è®¡ç®—é¼ æ ‡åœ¨ Canvas ä¸­çš„å½’ä¸€åŒ–åæ ‡
            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            // å°„çº¿æ£€æµ‹
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(provinceGroup.children, true);

            // é‡ç½®ä¹‹å‰æ‚¬åœçš„ Mesh
            if (hoveredMesh && hoveredMesh !== selectedMesh) {
                resetMeshColor(hoveredMesh);
                hoveredMesh = null;
            }

            // é«˜äº®å½“å‰æ‚¬åœçš„ Mesh
            if (intersects.length > 0) {
                let targetMesh = intersects[0].object;
                
                // å¦‚æœæ˜¯ Groupï¼Œè·å–å…¶çˆ¶çº§
                while (targetMesh.parent && targetMesh.parent !== provinceGroup) {
                    targetMesh = targetMesh.parent;
                }

                if (targetMesh !== selectedMesh) {
                    hoveredMesh = targetMesh;
                    highlightMesh(targetMesh, 0xFFD700); // é»„è‰²é«˜äº®
                    document.body.style.cursor = 'pointer';
                }
            } else {
                document.body.style.cursor = 'default';
            }
        }

        // ==================== é¼ æ ‡ç‚¹å‡»äº‹ä»¶ ====================
        let mouseDownPos = { x: 0, y: 0 };
        let mouseUpPos = { x: 0, y: 0 };

        function onMouseDown(event) {
            mouseDownPos = { x: event.clientX, y: event.clientY };
        }

        function onMouseUp(event) {
            mouseUpPos = { x: event.clientX, y: event.clientY };

            // è®¡ç®—é¼ æ ‡ç§»åŠ¨è·ç¦»
            const dx = mouseUpPos.x - mouseDownPos.x;
            const dy = mouseUpPos.y - mouseDownPos.y;
            const distance = Math.sqrt(dx * dx + dy * dy);

            // å¦‚æœç§»åŠ¨è·ç¦»å°äº5åƒç´ ï¼Œè§†ä¸ºç‚¹å‡»
            if (distance < 5) {
                handleClick(event);
            }
        }

        function handleClick(event) {
            const container = document.getElementById('map-container');
            const rect = container.getBoundingClientRect();

            mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
            mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(provinceGroup.children, true);

            if (intersects.length > 0) {
                let targetMesh = intersects[0].object;

                // è·å–é¡¶å±‚ Mesh æˆ– Group
                while (targetMesh.parent && targetMesh.parent !== provinceGroup) {
                    targetMesh = targetMesh.parent;
                }

                const provinceName = targetMesh.name || targetMesh.userData.provinceName;

                if (provinceName) {
                    console.log('âœ… ç‚¹å‡»çœä»½:', provinceName);
                    selectProvince(targetMesh, provinceName);
                }
            }
        }

        // ==================== é€‰ä¸­çœä»½ ====================
        function selectProvince(mesh, provinceName) {
            // é‡ç½®ä¹‹å‰é€‰ä¸­çš„ Mesh
            if (selectedMesh) {
                resetMeshColor(selectedMesh);
            }

            // é«˜äº®æ–°é€‰ä¸­çš„ Mesh
            selectedMesh = mesh;
            highlightMesh(mesh, 0xFFD700); // é»„è‰²é«˜äº®

            // åŠ è½½çœä»½ä¿¡æ¯
            loadProvinceInfo(provinceName);
        }

        // ==================== é«˜äº® Mesh ====================
        function highlightMesh(mesh, color) {
            if (mesh.type === 'Group') {
                mesh.children.forEach(child => {
                    if (child.material) {
                        if (Array.isArray(child.material)) {
                            child.material.forEach(mat => mat.color.setHex(color));
                        } else {
                            child.material.color.setHex(color);
                        }
                    }
                });
            } else if (mesh.material) {
                if (Array.isArray(mesh.material)) {
                    mesh.material.forEach(mat => mat.color.setHex(color));
                } else {
                    mesh.material.color.setHex(color);
                }
            }
        }

        // ==================== é‡ç½® Mesh é¢œè‰² ====================
        function resetMeshColor(mesh) {
            if (mesh.type === 'Group') {
                mesh.children.forEach(child => {
                    if (child.material && child.userData.originalColor) {
                        child.material.color.setHex(child.userData.originalColor);
                    }
                });
            } else if (mesh.material && mesh.userData.originalColor) {
                mesh.material.color.setHex(mesh.userData.originalColor);
            }
        }

        // ==================== åŠ è½½çœä»½ä¿¡æ¯ï¼ˆè°ƒç”¨åç«¯APIï¼‰ ====================
        function loadProvinceInfo(provinceName) {
            console.log('åŠ è½½çœä»½ä¿¡æ¯:', provinceName);

            // æŸ¥æ‰¾çœä»½ ID
            let provinceId = provinceNameToId[provinceName];

            if (!provinceId) {
                // æ¨¡ç³ŠåŒ¹é…
                for (let key in provinceNameToId) {
                    if (provinceName.includes(key) || key.includes(provinceName)) {
                        provinceId = provinceNameToId[key];
                        currentProvince = key.replace('çœ', '').replace('å¸‚', '');
                        break;
                    }
                }
            } else {
                currentProvince = provinceName.replace('çœ', '').replace('å¸‚', '');
            }

            if (!provinceId) {
                $('#info-panel').html(`
                    <div class="info-title">${provinceName}</div>
                    <p style="color: #e74c3c; text-align: center; padding: 50px 20px;">
                        æš‚æ— è¯¥çœä»½çš„è¯¦ç»†ä¿¡æ¯
                    </p>
                `);
                return;
            }

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            $('#info-panel').html('<div class="loading">åŠ è½½ä¸­...</div>');

            // è°ƒç”¨ API è·å–åŸå¸‚åˆ—è¡¨
            $.ajax({
                url: `/api/cities/${provinceId}`,
                method: 'GET',
                success: function(response) {
                    if (response.code === 200 && response.data) {
                        displayCities(currentProvince, response.data);
                    } else {
                        $('#info-panel').html('<p style="color: #e74c3c;">åŠ è½½å¤±è´¥</p>');
                    }
                },
                error: function() {
                    $('#info-panel').html('<p style="color: #e74c3c;">ç½‘ç»œé”™è¯¯</p>');
                }
            });
        }

        // ==================== æ˜¾ç¤ºåŸå¸‚åˆ—è¡¨ ====================
        function displayCities(provinceName, cities) {
            let html = `
                <div class="info-title">${provinceName}çœ - åŸå¸‚åˆ—è¡¨</div>
                <div class="city-list">
            `;

            cities.forEach(city => {
                const desc = city.description || 'æš‚æ— æè¿°';
                const shortDesc = desc.length > 50 ? desc.substring(0, 50) + '...' : desc;

                html += `
                    <button class="city-button" data-city-id="${city.id}" data-city-name="${city.name}">
                        <div class="city-button-name">${city.name}</div>
                        <div class="city-button-desc">${shortDesc}</div>
                    </button>
                `;
            });

            html += '</div>';
            $('#info-panel').html(html);

            // ç»‘å®šåŸå¸‚æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            $('.city-button').click(function() {
                const cityId = $(this).data('city-id');
                const cityName = $(this).data('city-name');
                loadCityAttractions(cityId, cityName);
            });
        }

        // ==================== åŠ è½½åŸå¸‚æ™¯ç‚¹ ====================
        function loadCityAttractions(cityId, cityName) {
            $('#info-panel').html('<div class="loading">åŠ è½½æ™¯ç‚¹ä¸­...</div>');

            $.ajax({
                url: `/api/attractions/top/${cityId}?limit=50`,
                method: 'GET',
                success: function(response) {
                    if (response.code === 200 && response.data) {
                        displayAttractions(cityName, response.data);
                    } else {
                        $('#info-panel').html('<p style="color: #e74c3c;">åŠ è½½æ™¯ç‚¹å¤±è´¥</p>');
                    }
                },
                error: function() {
                    $('#info-panel').html('<p style="color: #e74c3c;">ç½‘ç»œé”™è¯¯</p>');
                }
            });
        }

        // ==================== æ˜¾ç¤ºæ™¯ç‚¹åˆ—è¡¨ ====================
        function displayAttractions(cityName, attractions) {
            let html = `
                <button class="back-button" onclick="loadProvinceInfo('${currentProvince}')">â† è¿”å›åŸå¸‚åˆ—è¡¨</button>
                <div class="info-title">${cityName} - çƒ­é—¨æ™¯ç‚¹</div>
                <div class="attraction-list">
            `;

            if (attractions && attractions.length > 0) {
                attractions.forEach((attraction, index) => {
                    const desc = attraction.description || 'æš‚æ— æè¿°';
                    const shortDesc = desc.length > 60 ? desc.substring(0, 60) + '...' : desc;

                    html += `
                        <div class="attraction-card" data-attraction-id="${attraction.id}">
                            <div class="attraction-card-title">${index + 1}. ${attraction.name}</div>
                            <div class="attraction-card-desc">${shortDesc}</div>
                            <div class="attraction-card-stats">
                                <span class="attraction-card-rating">â­ ${attraction.rating || 'N/A'}</span>
                                <span class="attraction-card-views">ğŸ‘ï¸ ${attraction.viewCount || 0}</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<p style="color: #95a5a6; text-align: center;">æš‚æ— æ™¯ç‚¹æ•°æ®</p>';
            }

            html += '</div>';
            $('#info-panel').html(html);

            // ç»‘å®šæ™¯ç‚¹å¡ç‰‡ç‚¹å‡»äº‹ä»¶
            $('.attraction-card').click(function() {
                const attractionId = $(this).data('attraction-id');
                // è·³è½¬åˆ°è¯¦æƒ…é¡µ
                window.open('detail.html?id=' + attractionId, '_blank');
            });
        }

        // ==================== æ¸²æŸ“å¾ªç¯ ====================
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // ==================== çª—å£å¤§å°è°ƒæ•´ ====================
        function onWindowResize() {
            const container = document.getElementById('map-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }

        // ==================== åˆå§‹åŒ– ====================
        $(document).ready(function() {
            console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ– Three.js ä¸­å›½åœ°å›¾...');

            // æ£€æŸ¥ç™»å½•çŠ¶æ€
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                window.location.href = 'login.html';
                return;
            }
            $('#username').text(user.username);

            // åˆå§‹åŒ– Three.js
            initThreeJS();

            // åŠ è½½åœ°å›¾æ•°æ®
            loadChinaMap();

            // ç»‘å®šäº‹ä»¶
            const canvas = document.getElementById('threejs-canvas');
            canvas.addEventListener('mousemove', onMouseMove, false);
            canvas.addEventListener('mousedown', onMouseDown, false);
            canvas.addEventListener('mouseup', onMouseUp, false);
            window.addEventListener('resize', onWindowResize, false);

            // å¯åŠ¨æ¸²æŸ“å¾ªç¯
            animate();

            console.log('âœ… Three.js ä¸­å›½åœ°å›¾åˆå§‹åŒ–å®Œæˆ');
        });

        // é€€å‡ºç™»å½•
        function logout() {
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // è¿”å›é¦–é¡µ
        function goHome() {
            window.location.href = 'home.html';
        }
    </script>
</body>
</html>
