<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.learning.travelingassistant.mapper.FriendMapper">

    <insert id="insertRequest" parameterType="com.learning.travelingassistant.entity.FriendRequest" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO friend_request (sender_id, receiver_id, status, create_time, update_time)
        VALUES (#{senderId}, #{receiverId}, #{status}, NOW(), NOW())
    </insert>

    <update id="updateRequestStatus">
        UPDATE friend_request
        SET status = #{status}, update_time = NOW()
        WHERE id = #{id}
    </update>

    <select id="findRequestById" resultType="com.learning.travelingassistant.entity.FriendRequest">
        SELECT id, sender_id, receiver_id, status, create_time, update_time
        FROM friend_request
        WHERE id = #{id}
    </select>

    <select id="findPendingRequest" resultType="com.learning.travelingassistant.entity.FriendRequest">
        SELECT id, sender_id, receiver_id, status, create_time, update_time
        FROM friend_request
        WHERE sender_id = #{senderId} AND receiver_id = #{receiverId} AND status = 0
    </select>

    <select id="findPendingRequestsByReceiver" resultType="com.learning.travelingassistant.entity.FriendRequest">
        SELECT fr.id, fr.sender_id, fr.receiver_id, fr.status, fr.create_time, fr.update_time,
               u.username as senderUsername, u.account_id as senderAccountId
        FROM friend_request fr
        LEFT JOIN users u ON fr.sender_id = u.id
        WHERE fr.receiver_id = #{receiverId} AND fr.status = 0
        ORDER BY fr.create_time DESC
    </select>

    <insert id="insertFriendship" parameterType="com.learning.travelingassistant.entity.Friendship">
        INSERT INTO friendship (user_id, friend_id, create_time)
        VALUES (#{userId}, #{friendId}, NOW())
    </insert>

    <delete id="deleteFriendship">
        DELETE FROM friendship
        WHERE user_id = #{userId} AND friend_id = #{friendId}
    </delete>

    <select id="findFriendship" resultType="com.learning.travelingassistant.entity.Friendship">
        SELECT id, user_id, friend_id, create_time
        FROM friendship
        WHERE user_id = #{userId} AND friend_id = #{friendId}
    </select>

    <select id="findFriendsByUserId" resultType="com.learning.travelingassistant.entity.Friendship">
        SELECT f.id, f.user_id, f.friend_id, f.create_time,
               u.username as friendUsername, u.account_id as friendAccountId,
               u.phone as friendPhone, u.email as friendEmail
        FROM friendship f
        LEFT JOIN users u ON f.friend_id = u.id
        WHERE f.user_id = #{userId}
        ORDER BY f.create_time DESC
    </select>

</mapper>